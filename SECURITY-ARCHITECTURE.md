# ğŸ”’ SECURITY ARCHITECTURE DOCUMENTATION

## ğŸ“ SYSTEM ARCHITECTURE DIAGRAM

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         CLIENT LAYER (Browser)                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚   React SPA  â”‚  â”‚ Stripe.js    â”‚  â”‚ OAuth Popup  â”‚                â”‚
â”‚  â”‚   (Vite)     â”‚  â”‚ Elements     â”‚  â”‚ (GitHub/     â”‚                â”‚
â”‚  â”‚              â”‚  â”‚              â”‚  â”‚  Discord)    â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚         â”‚                 â”‚                  â”‚                         â”‚
â”‚         â”‚ HTTPS           â”‚ HTTPS            â”‚ OAuth2 Flow             â”‚
â”‚         â”‚ (SSL/TLS)       â”‚                  â”‚                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                 â”‚                  â”‚
          â–¼                 â–¼                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      REVERSE PROXY LAYER (Nginx)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Security Headers:                                               â”‚  â”‚
â”‚  â”‚  â€¢ X-Frame-Options: DENY                                        â”‚  â”‚
â”‚  â”‚  â€¢ X-Content-Type-Options: nosniff                              â”‚  â”‚
â”‚  â”‚  â€¢ Content-Security-Policy (CSP)                                â”‚  â”‚
â”‚  â”‚  â€¢ Strict-Transport-Security (HSTS)                             â”‚  â”‚
â”‚  â”‚  â€¢ X-XSS-Protection: 1; mode=block                              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  SSL/TLS Termination (Let's Encrypt)                            â”‚  â”‚
â”‚  â”‚  â€¢ TLS 1.2+ only                                                â”‚  â”‚
â”‚  â”‚  â€¢ Strong cipher suites                                         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                         â”‚
â”‚         frontend:80 â—„â”€â”€â”€â”€â”€â”€â”      api.domain:443 â—„â”€â”€â”€â”€â”€â”€â”            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚                           â”‚
                              â–¼                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   FRONTEND CONTAINER (Nginx)     â”‚  â”‚   BACKEND CONTAINER (Node.js)   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ Static file serving           â”‚  â”‚                                 â”‚
â”‚  â€¢ Client-side routing (SPA)     â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â€¢ Gzip compression               â”‚  â”‚  â”‚   Security Middleware      â”‚â”‚
â”‚  â€¢ Cache headers                  â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚  1. Helmet (headers)       â”‚â”‚
                                       â”‚  â”‚  2. CORS (origin check)    â”‚â”‚
                                       â”‚  â”‚  3. HPP (param pollution)  â”‚â”‚
                                       â”‚  â”‚  4. MongoSanitize         â”‚â”‚
                                       â”‚  â”‚  5. Rate Limiting          â”‚â”‚
                                       â”‚  â”‚  6. Cookie Parser          â”‚â”‚
                                       â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
                                       â”‚                                 â”‚
                                       â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
                                       â”‚  â”‚   Application Layer        â”‚â”‚
                                       â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚
                                       â”‚  â”‚  â€¢ Express.js API          â”‚â”‚
                                       â”‚  â”‚  â€¢ Passport.js (OAuth)     â”‚â”‚
                                       â”‚  â”‚  â€¢ JWT Auth                â”‚â”‚
                                       â”‚  â”‚  â€¢ Input Validation (Joi)  â”‚â”‚
                                       â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
                                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                       â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚                                      â”‚                    â”‚
                â–¼                                      â–¼                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   DATABASE LAYER         â”‚  â”‚   SECRETS MANAGEMENT     â”‚  â”‚  EXTERNAL APIs  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  MongoDB Container       â”‚  â”‚  HashiCorp Vault         â”‚  â”‚  â€¢ Stripe API   â”‚
â”‚  â€¢ Port 27017 (local)    â”‚  â”‚  (Optional - Dev mode)   â”‚  â”‚  â€¢ Google OAuth â”‚
â”‚  â€¢ No external access    â”‚  â”‚  â€¢ Token-based auth      â”‚  â”‚  â€¢ GitHub OAuth â”‚
â”‚  â€¢ Data encryption       â”‚  â”‚  â€¢ KV secrets engine     â”‚  â”‚  â€¢ Discord OAuthâ”‚
â”‚  at rest (planned)       â”‚  â”‚  â€¢ Fallback to .env      â”‚  â”‚  â€¢ Brevo SMTP   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      MONITORING LAYER (Optional)                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚  Prometheus   â”‚  â”‚   Grafana     â”‚  â”‚ Alertmanagerâ”‚                â”‚
â”‚  â”‚  (Metrics)    â”‚  â”‚  (Dashboard)  â”‚  â”‚   (Alerts)  â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚         â”‚                   â”‚                   â”‚                       â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                             â”‚                                           â”‚
â”‚                  monitoring.domain:3001                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” AUTHENTICATION FLOW DIAGRAMS

### 1ï¸âƒ£ **Local Login Flow (Email + Password)**

```
â”Œâ”€â”€â”€â”€â”€â”€â”                                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Clientâ”‚                                                    â”‚  Server  â”‚
â””â”€â”€â”¬â”€â”€â”€â”˜                                                    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
   â”‚                                                             â”‚
   â”‚  POST /api/v1/auth/login                                   â”‚
   â”‚  { email, password }                                       â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º
   â”‚                                                             â”‚
   â”‚                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
   â”‚                        â”‚ 1. Validate Input (Joi)        â”‚  â”‚
   â”‚                        â”‚ 2. Check Rate Limit (5/min)    â”‚  â”‚
   â”‚                        â”‚ 3. Find User by Email          â”‚  â”‚
   â”‚                        â”‚ 4. Check Account Lock          â”‚  â”‚
   â”‚                        â”‚ 5. Compare Password (bcrypt)   â”‚  â”‚
   â”‚                        â”‚ 6. Check Email Verified        â”‚  â”‚
   â”‚                        â”‚ 7. Check 2FA Enabled           â”‚  â”‚
   â”‚                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
   â”‚                                                             â”‚
   â”‚â—„â”€â”€â”€ IF 2FA ENABLED â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚  200 OK                                                     â”‚
   â”‚  { requiresTwoFactor: true, tempToken }                    â”‚
   â”‚                                                             â”‚
   â”‚  POST /api/v1/auth/login/2fa                               â”‚
   â”‚  { tempToken, code }                                       â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º
   â”‚                                                             â”‚
   â”‚                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
   â”‚                        â”‚ 1. Verify Temp Token           â”‚  â”‚
   â”‚                        â”‚ 2. Verify TOTP Code (6 digits) â”‚  â”‚
   â”‚                        â”‚ 3. Generate Device Fingerprint â”‚  â”‚
   â”‚                        â”‚ 4. Sign Access Token (15m)     â”‚  â”‚
   â”‚                        â”‚ 5. Sign Refresh Token (7d)     â”‚  â”‚
   â”‚                        â”‚ 6. Save Refresh Token to DB    â”‚  â”‚
   â”‚                        â”‚ 7. Set httpOnly Cookie         â”‚  â”‚
   â”‚                        â”‚ 8. Log Auth Event (Audit)      â”‚  â”‚
   â”‚                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
   â”‚                                                             â”‚
   â”‚â—„â”€â”€â”€ SUCCESS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚  200 OK                                                     â”‚
   â”‚  Set-Cookie: refreshToken=xxx; HttpOnly; Secure; SameSite  â”‚
   â”‚  {                                                          â”‚
   â”‚    accessToken: "eyJhbGc...",                              â”‚
   â”‚    user: { id, email, role, ... }                          â”‚
   â”‚  }                                                          â”‚
   â”‚                                                             â”‚
   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
   â”‚  â”‚ Client stores accessToken in:   â”‚                       â”‚
   â”‚  â”‚ â€¢ Memory (React Context)         â”‚                       â”‚
   â”‚  â”‚ â€¢ NOT localStorage (XSS risk)    â”‚                       â”‚
   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
   â”‚                                                             â”‚
```

---

### 2ï¸âƒ£ **OAuth2 Login Flow (GitHub/Discord/Google)**

```
â”Œâ”€â”€â”€â”€â”€â”€â”                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Clientâ”‚                     â”‚  Server  â”‚                  â”‚  Provider  â”‚
â””â”€â”€â”¬â”€â”€â”€â”˜                     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
   â”‚                              â”‚                              â”‚
   â”‚ Click "Login with GitHub"    â”‚                              â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                              â”‚
   â”‚                              â”‚                              â”‚
   â”‚  GET /api/v1/oauth/github    â”‚                              â”‚
   â”‚                              â”‚                              â”‚
   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                              â”‚
   â”‚  302 Redirect to GitHub      â”‚                              â”‚
   â”‚  with state parameter        â”‚                              â”‚
   â”‚                              â”‚                              â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
   â”‚  GitHub Authorization Page   â”‚                              â”‚
   â”‚  (User grants permission)    â”‚                              â”‚
   â”‚                              â”‚                              â”‚
   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚  302 Redirect to callback    â”‚                              â”‚
   â”‚  with code & state           â”‚                              â”‚
   â”‚                              â”‚                              â”‚
   â”‚  GET /oauth/github/callback  â”‚                              â”‚
   â”‚  ?code=xxx&state=yyy         â”‚                              â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                              â”‚
   â”‚                              â”‚                              â”‚
   â”‚                              â”‚  POST /oauth/token           â”‚
   â”‚                              â”‚  Exchange code for token     â”‚
   â”‚                              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
   â”‚                              â”‚                              â”‚
   â”‚                              â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚                              â”‚  { access_token }            â”‚
   â”‚                              â”‚                              â”‚
   â”‚                              â”‚  GET /user                   â”‚
   â”‚                              â”‚  Authorization: Bearer token â”‚
   â”‚                              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
   â”‚                              â”‚                              â”‚
   â”‚                              â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚                              â”‚  { id, email, name, avatar } â”‚
   â”‚                              â”‚                              â”‚
   â”‚               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
   â”‚               â”‚ 1. Find user by oauth2Id         â”‚          â”‚
   â”‚               â”‚ 2. If not found, create new user â”‚          â”‚
   â”‚               â”‚ 3. Set provider='oauth2'         â”‚          â”‚
   â”‚               â”‚ 4. Mark email as verified        â”‚          â”‚
   â”‚               â”‚ 5. Generate JWT tokens           â”‚          â”‚
   â”‚               â”‚ 6. Set refresh token cookie      â”‚          â”‚
   â”‚               â”‚ 7. Log OAuth event (Audit)       â”‚          â”‚
   â”‚               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
   â”‚                              â”‚                              â”‚
   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                              â”‚
   â”‚  302 Redirect to frontend    â”‚                              â”‚
   â”‚  /auth/callback?token=xxx    â”‚                              â”‚
   â”‚                              â”‚                              â”‚
   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                              â”‚
   â”‚  â”‚ Frontend extracts tokenâ”‚  â”‚                              â”‚
   â”‚  â”‚ from URL params        â”‚  â”‚                              â”‚
   â”‚  â”‚ Stores in memory       â”‚  â”‚                              â”‚
   â”‚  â”‚ Redirects to /         â”‚  â”‚                              â”‚
   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                              â”‚
```

---

### 3ï¸âƒ£ **JWT Token Refresh Flow**

```
â”Œâ”€â”€â”€â”€â”€â”€â”                                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Clientâ”‚                                                    â”‚  Server  â”‚
â””â”€â”€â”¬â”€â”€â”€â”˜                                                    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
   â”‚                                                             â”‚
   â”‚  API Request with expired accessToken                      â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º
   â”‚                                                             â”‚
   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚  401 Unauthorized                                           â”‚
   â”‚  { error: "Invalid or expired token" }                     â”‚
   â”‚                                                             â”‚
   â”‚  POST /api/v1/auth/refresh                                 â”‚
   â”‚  Cookie: refreshToken=xxx                                  â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º
   â”‚                                                             â”‚
   â”‚                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
   â”‚                        â”‚ 1. Extract refresh token from  â”‚  â”‚
   â”‚                        â”‚    cookie (httpOnly)           â”‚  â”‚
   â”‚                        â”‚ 2. Verify JWT signature        â”‚  â”‚
   â”‚                        â”‚ 3. Hash token (SHA-256)        â”‚  â”‚
   â”‚                        â”‚ 4. Find in DB by hash          â”‚  â”‚
   â”‚                        â”‚ 5. Check expiry & revoked      â”‚  â”‚
   â”‚                        â”‚ 6. Validate token family       â”‚  â”‚
   â”‚                        â”‚ 7. Check user tokenVersion     â”‚  â”‚
   â”‚                        â”‚ 8. Detect reuse (replay)       â”‚  â”‚
   â”‚                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
   â”‚                                                             â”‚
   â”‚â—„â”€â”€â”€ IF REUSE DETECTED â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚  403 Forbidden                                              â”‚
   â”‚  âš ï¸  Revoke entire token family (security breach!)         â”‚
   â”‚                                                             â”‚
   â”‚â—„â”€â”€â”€ SUCCESS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚  200 OK                                                     â”‚
   â”‚  {                                                          â”‚
   â”‚    accessToken: "new-token-here",                          â”‚
   â”‚    user: { ... }                                           â”‚
   â”‚  }                                                          â”‚
   â”‚  Set-Cookie: refreshToken=new-refresh-token (rotated)      â”‚
   â”‚                                                             â”‚
   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
   â”‚  â”‚ Token Rotation:                                 â”‚       â”‚
   â”‚  â”‚ â€¢ Old refresh token invalidated                 â”‚       â”‚
   â”‚  â”‚ â€¢ New refresh token issued (same family)        â”‚       â”‚
   â”‚  â”‚ â€¢ Prevents token reuse attacks                  â”‚       â”‚
   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
```

---

## ğŸ›¡ï¸ SECURITY LAYERS DIAGRAM

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        DEFENSE IN DEPTH                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Layer 7: MONITORING & INCIDENT RESPONSE
â”œâ”€ Audit Logging (All auth events)
â”œâ”€ Prometheus Metrics (Failed logins, rate limits)
â”œâ”€ Email Alerts (Suspicious activity, account locks)
â””â”€ Manual Review (Admin audit dashboard)
         â”‚
         â–¼
Layer 6: DATA PROTECTION
â”œâ”€ AES-256-GCM Encryption (2FA secrets, sensitive fields)
â”œâ”€ bcrypt Password Hashing (12 rounds)
â”œâ”€ SHA-256 Token Hashing (Refresh tokens in DB)
â””â”€ Field-level Encryption (PII data)
         â”‚
         â–¼
Layer 5: AUTHORIZATION
â”œâ”€ Role-Based Access Control (RBAC: user, admin)
â”œâ”€ Email Verification Required (for sensitive ops)
â”œâ”€ Resource Ownership Check (userId matching)
â””â”€ Admin-only Routes Protected
         â”‚
         â–¼
Layer 4: AUTHENTICATION
â”œâ”€ JWT with Fingerprinting (Device binding)
â”œâ”€ Token Versioning (Instant invalidation)
â”œâ”€ Refresh Token Rotation (Replay detection)
â”œâ”€ Multi-Factor Authentication (TOTP 2FA)
â”œâ”€ OAuth2 Integration (Google, GitHub, Discord)
â””â”€ Account Lockout (5 failed attempts â†’ 15min lock)
         â”‚
         â–¼
Layer 3: INPUT VALIDATION & SANITIZATION
â”œâ”€ Joi Schema Validation (Type & format checks)
â”œâ”€ express-mongo-sanitize (NoSQL injection prevention)
â”œâ”€ hpp (HTTP Parameter Pollution protection)
â”œâ”€ Password Policy (12+ chars, complexity rules)
â”œâ”€ Email Validation (Format + disposable check)
â””â”€ File Upload Validation (Type, size, mimetype)
         â”‚
         â–¼
Layer 2: APPLICATION SECURITY
â”œâ”€ CORS Policy (Origin whitelist)
â”œâ”€ Content Security Policy (CSP headers)
â”œâ”€ Rate Limiting (5/min auth, 10000/15min general)
â”œâ”€ Helmet Security Headers (X-Frame, X-XSS, etc.)
â”œâ”€ Cookie Security (HttpOnly, Secure, SameSite)
â””â”€ Session Management (Device tracking, IP logging)
         â”‚
         â–¼
Layer 1: NETWORK & INFRASTRUCTURE
â”œâ”€ HTTPS/TLS (SSL certificates via Let's Encrypt)
â”œâ”€ Nginx Reverse Proxy (Request filtering)
â”œâ”€ Docker Network Isolation (Internal communication)
â”œâ”€ MongoDB Port Binding (127.0.0.1 only)
â””â”€ Firewall Rules (UFW on VPS)
```

---

## ğŸ’³ PAYMENT FLOW DIAGRAM (Stripe)

```
â”Œâ”€â”€â”€â”€â”€â”€â”                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Clientâ”‚                  â”‚  Server  â”‚                  â”‚ Stripe  â”‚
â””â”€â”€â”¬â”€â”€â”€â”˜                  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
   â”‚                           â”‚                             â”‚
   â”‚ Load Stripe.js Elements   â”‚                             â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                             â”‚
   â”‚                           â”‚                             â”‚
   â”‚  User enters card info    â”‚                             â”‚
   â”‚  (directly to Stripe DOM) â”‚                             â”‚
   â”‚  âš ï¸  Server NEVER sees    â”‚                             â”‚
   â”‚      card numbers!        â”‚                             â”‚
   â”‚                           â”‚                             â”‚
   â”‚  createPaymentIntent()    â”‚                             â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                             â”‚
   â”‚                           â”‚                             â”‚
   â”‚                           â”‚  POST /v1/payment_intents   â”‚
   â”‚                           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
   â”‚                           â”‚  {                          â”‚
   â”‚                           â”‚    amount: 1000,            â”‚
   â”‚                           â”‚    currency: 'usd'          â”‚
   â”‚                           â”‚  }                          â”‚
   â”‚                           â”‚                             â”‚
   â”‚                           â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚                           â”‚  { client_secret }          â”‚
   â”‚                           â”‚                             â”‚
   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                             â”‚
   â”‚  { clientSecret }         â”‚                             â”‚
   â”‚                           â”‚                             â”‚
   â”‚  stripe.confirmCardPaymentâ”‚                             â”‚
   â”‚  (clientSecret, cardElement)                            â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º
   â”‚                           â”‚                             â”‚
   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚  { paymentIntent }        â”‚                             â”‚
   â”‚                           â”‚                             â”‚
   â”‚                           â”‚  Webhook Event:             â”‚
   â”‚                           â”‚  payment_intent.succeeded   â”‚
   â”‚                           â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚                           â”‚                             â”‚
   â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
   â”‚         â”‚ 1. Verify webhook signature             â”‚     â”‚
   â”‚         â”‚    (STRIPE_WEBHOOK_SECRET)              â”‚     â”‚
   â”‚         â”‚ 2. Parse event type                     â”‚     â”‚
   â”‚         â”‚ 3. Update order status in DB            â”‚     â”‚
   â”‚         â”‚ 4. Send confirmation email              â”‚     â”‚
   â”‚         â”‚ 5. Log payment event (Audit)            â”‚     â”‚
   â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
   â”‚                           â”‚                             â”‚
   â”‚  âœ… Payment confirmed     â”‚                             â”‚
   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                             â”‚
```

**PCI DSS Compliance:**
- âœ… No card data touches server
- âœ… Stripe Elements (SAQ-A compliant)
- âœ… Webhook signature verification
- âœ… TLS 1.2+ for all communication

---

## ğŸ” THREAT MODEL DIAGRAM

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      THREAT ACTORS & MITIGATIONS                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ¯ ATTACK VECTOR                    ğŸ›¡ï¸  MITIGATION IN PLACE
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

1. Brute Force Password Attack      â‡¨  â€¢ bcrypt (12 rounds) = slow
   â€¢ Automated login attempts           â€¢ Account lockout (5 attempts)
   â€¢ Credential stuffing                â€¢ Rate limiting (5/min)
                                        â€¢ CAPTCHA (future improvement)

2. SQL/NoSQL Injection               â‡¨  â€¢ Mongoose ODM (parameterized)
   â€¢ Malicious query injection          â€¢ express-mongo-sanitize
   â€¢ $where operator abuse              â€¢ Input validation (Joi)

3. Cross-Site Scripting (XSS)        â‡¨  â€¢ Content-Security-Policy (CSP)
   â€¢ Stored XSS in product reviews      â€¢ React auto-escaping
   â€¢ Reflected XSS in URLs              â€¢ DOMPurify (if using innerHTML)
                                        â€¢ HttpOnly cookies

4. Cross-Site Request Forgery        â‡¨  â€¢ SameSite=Lax cookies
   â€¢ Unauthorized actions               â€¢ Stateless JWT (no CSRF token)
   â€¢ State-changing requests            â€¢ Origin validation (CORS)

5. JWT Token Theft                   â‡¨  â€¢ Device fingerprinting
   â€¢ XSS stealing accessToken           â€¢ Token versioning
   â€¢ Man-in-the-middle                  â€¢ HTTPS only (TLS)
                                        â€¢ Short expiry (15min)

6. Session Hijacking                 â‡¨  â€¢ Refresh token rotation
   â€¢ Token replay attacks               â€¢ Token family tracking
   â€¢ Stolen refresh tokens              â€¢ Revoke on reuse detection

7. Account Takeover                  â‡¨  â€¢ 2FA/TOTP required
   â€¢ Phishing credentials               â€¢ Email alerts (suspicious login)
   â€¢ Social engineering                 â€¢ Password reset via email
                                        â€¢ Backup codes

8. Man-in-the-Middle (MITM)          â‡¨  â€¢ HTTPS/TLS everywhere
   â€¢ Traffic interception               â€¢ HSTS header (force HTTPS)
   â€¢ Certificate spoofing               â€¢ Certificate pinning (future)

9. Denial of Service (DoS)           â‡¨  â€¢ Rate limiting (multiple tiers)
   â€¢ API flooding                       â€¢ Request size limits
   â€¢ Resource exhaustion                â€¢ CloudFlare (production)

10. Prototype Pollution              â‡¨  â€¢ hpp middleware
    â€¢ JSON payload manipulation         â€¢ Object.freeze() on configs
    â€¢ __proto__ injection               â€¢ Joi strict validation

11. Server-Side Request Forgery      â‡¨  â€¢ URL validation
    â€¢ Internal network scanning         â€¢ Whitelist external APIs
    â€¢ Cloud metadata access             â€¢ No user-controlled URLs

12. Information Disclosure           â‡¨  â€¢ Generic error messages
    â€¢ Stack traces leaked               â€¢ Email enumeration prevention
    â€¢ Verbose error responses           â€¢ Timing attack mitigation
                                        â€¢ Password field select: false

13. Insecure Dependencies            â‡¨  â€¢ npm audit (regular scans)
    â€¢ Known CVEs in packages            â€¢ Dependabot alerts
    â€¢ Outdated libraries                â€¢ Snyk monitoring (future)

14. Insufficient Logging             â‡¨  â€¢ Audit log all auth events
    â€¢ Missing security events           â€¢ Pino structured logging
    â€¢ No audit trail                    â€¢ Prometheus metrics
                                        â€¢ Admin audit dashboard
```

---

## ğŸ“Š DATA FLOW DIAGRAM

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      SENSITIVE DATA LIFECYCLE                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. USER PASSWORD
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     bcrypt        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Plaintext  â”œâ”€â”€â”€â”€â”€(12 rounds)â”€â”€â”€â–ºâ”‚ Hash (DB)    â”‚
   â”‚ Password   â”‚                    â”‚ $2b$12$...   â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â€¢ Never logged
   â€¢ Never transmitted in response
   â€¢ Never stored in plaintext
   â€¢ Select: false (Mongoose)

2. JWT TOKENS
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    Sign (HS256)   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Payload:    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ JWT String   â”‚
   â”‚ {sub, role} â”‚    Secret Key      â”‚ eyJhbGc...   â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â€¢ Access: Memory only (React context)
   â€¢ Refresh: HttpOnly cookie
   â€¢ Never in localStorage (XSS risk)

3. REFRESH TOKENS
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    SHA-256         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Raw Token   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ Hash (DB)    â”‚
   â”‚ uuid.v4()   â”‚                    â”‚ 64-char hex  â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â€¢ Hashed before storage
   â€¢ Rotated on each use
   â€¢ Family tracking (replay detection)

4. 2FA SECRETS
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   AES-256-GCM      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ TOTP Secret â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ Encrypted    â”‚
   â”‚ (32 chars)  â”‚    Random IV       â”‚ (DB)         â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    Auth Tag        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â€¢ Encrypted at rest
   â€¢ Decrypted only when verifying code
   â€¢ Select: false (Mongoose)

5. BACKUP CODES
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     bcrypt         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ 10 codes    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ Hashed array â”‚
   â”‚ (random)    â”‚    (12 rounds)     â”‚ in DB        â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â€¢ Shown once to user
   â€¢ Each code single-use
   â€¢ Compared via bcrypt

6. PAYMENT DATA
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Card Number â”‚    NEVER TOUCHED   â”‚ Server       â”‚
   â”‚ (Frontend)  â”œâ”€â”€â”€â”€â”€â”€â”€â”€Xâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ (PCI-DSS)    â”‚
   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º Stripe.js
                                        (Direct to Stripe)
   â€¢ Only payment_intent_id stored
   â€¢ Stripe handles all card data
   â€¢ SAQ-A compliance

7. AUDIT LOGS
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    Immutable       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Auth Events â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ MongoDB      â”‚
   â”‚ {user, IP}  â”‚    Append-only     â”‚ Collection   â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â€¢ eventType, userId, timestamp
   â€¢ IP address, user agent
   â€¢ Success/failure status
   â€¢ Never modified/deleted
```

---

## ğŸ” ENCRYPTION KEY HIERARCHY

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CRYPTOGRAPHIC KEY MANAGEMENT                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ROOT SECRET (Environment Variable)
â”œâ”€ ENCRYPTION_KEY (256-bit)
â”‚  â””â”€ Derived via PBKDF2 (100,000 iterations)
â”‚     â””â”€ Used for: AES-256-GCM field encryption
â”‚        â€¢ twoFactorSecret
â”‚        â€¢ trustedDevices
â”‚        â€¢ loginHistory
â”‚
â”œâ”€ JWT_ACCESS_SECRET (256-bit)
â”‚  â””â”€ Used for: HS256 signature
â”‚     â””â”€ Expiry: 15 minutes
â”‚
â”œâ”€ JWT_REFRESH_SECRET (256-bit)
â”‚  â””â”€ Used for: HS256 signature
â”‚     â””â”€ Expiry: 7 days
â”‚
â”œâ”€ STRIPE_SECRET_KEY (sk_test_...)
â”‚  â””â”€ Used for: Stripe API calls
â”‚     â””â”€ Never exposed to client
â”‚
â”œâ”€ STRIPE_WEBHOOK_SECRET (whsec_...)
â”‚  â””â”€ Used for: Webhook signature verification
â”‚     â””â”€ Prevents webhook spoofing
â”‚
â””â”€ OAUTH2 CLIENT SECRETS
   â”œâ”€ GOOGLE_CLIENT_SECRET
   â”œâ”€ GITHUB_CLIENT_SECRET
   â””â”€ DISCORD_CLIENT_SECRET
      â””â”€ Used for: OAuth token exchange

ğŸ”‘ KEY ROTATION POLICY (Recommended):
   â€¢ JWT secrets: Every 90 days
   â€¢ Encryption key: Every 180 days
   â€¢ OAuth secrets: On provider notification
   â€¢ Stripe keys: When switching live/test mode
```

---

## ğŸš¨ INCIDENT RESPONSE FLOW

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SECURITY INCIDENT HANDLING                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

SCENARIO 1: JWT Secret Compromised
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Detection:                                                      â”‚
â”‚ â€¢ Unauthorized API access from unknown IPs                     â”‚
â”‚ â€¢ JWT tokens with valid signatures but unrecognized users      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Response Steps:                                                 â”‚
â”‚ 1. Rotate JWT_ACCESS_SECRET & JWT_REFRESH_SECRET immediately   â”‚
â”‚ 2. Increment tokenVersion for ALL users in DB                  â”‚
â”‚ 3. DELETE all refresh tokens from database                     â”‚
â”‚ 4. Force logout all active sessions                            â”‚
â”‚ 5. Send email alert to all users                               â”‚
â”‚ 6. Enable mandatory password reset for all accounts            â”‚
â”‚ 7. Review audit logs for suspicious activity                   â”‚
â”‚ 8. Investigate source of compromise                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

SCENARIO 2: Database Breach
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Detection:                                                      â”‚
â”‚ â€¢ Unusual MongoDB connections from external IPs                â”‚
â”‚ â€¢ Data exfiltration detected                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Impact Assessment:                                              â”‚
â”‚ âœ… Passwords: Safe (bcrypt 12 rounds - not crackable quickly) â”‚
â”‚ âœ… 2FA Secrets: Encrypted (AES-256-GCM - attacker needs key)  â”‚
â”‚ âœ… Refresh Tokens: Hashed (SHA-256 - cannot reverse)          â”‚
â”‚ âš ï¸  Email Addresses: Exposed (PII leak)                       â”‚
â”‚ âš ï¸  Login History: Encrypted but IP addresses visible         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Response Steps:                                                 â”‚
â”‚ 1. Isolate MongoDB container (network disconnect)              â”‚
â”‚ 2. Rotate ENCRYPTION_KEY (re-encrypt all data)                 â”‚
â”‚ 3. Rotate all JWT secrets                                      â”‚
â”‚ 4. Force password reset for all users                          â”‚
â”‚ 5. Notify affected users (GDPR compliance)                     â”‚
â”‚ 6. Report to authorities if required                           â”‚
â”‚ 7. Forensic analysis of access logs                            â”‚
â”‚ 8. Implement MongoDB authentication (currently disabled!)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

SCENARIO 3: Suspicious Login Detected
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Detection Triggers:                                             â”‚
â”‚ â€¢ Device fingerprint mismatch                                  â”‚
â”‚ â€¢ Login from unusual geolocation                               â”‚
â”‚ â€¢ Multiple failed 2FA attempts                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Automated Response:                                             â”‚
â”‚ 1. âš ï¸  Log warning to audit system                             â”‚
â”‚ 2. ğŸ“§ Send email alert to user                                 â”‚
â”‚ 3. âŒ (Optional) Block login - require email verification      â”‚
â”‚ 4. ğŸ”’ (Optional) Force 2FA even if not enabled                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User Actions:                                                   â”‚
â”‚ â€¢ Review recent login history in dashboard                     â”‚
â”‚ â€¢ Revoke suspicious sessions/devices                           â”‚
â”‚ â€¢ Enable 2FA if not already active                             â”‚
â”‚ â€¢ Change password if compromise suspected                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ˆ SECURITY METRICS & MONITORING

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      PROMETHEUS METRICS TO TRACK                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

# Authentication Metrics
auth_login_total{status="success|failure",provider="local|google|github"}
auth_login_failed_total{reason="invalid_password|account_locked|2fa_failed"}
auth_account_locked_total
auth_2fa_enabled_total
auth_2fa_backup_used_total

# Token Metrics
jwt_refresh_total{status="success|failure"}
jwt_refresh_reuse_detected_total  # ğŸš¨ Critical security alert!
jwt_fingerprint_mismatch_total    # Possible token theft

# Rate Limiting
rate_limit_exceeded_total{endpoint="/api/v1/auth/login"}

# Security Events
suspicious_login_detected_total
password_reset_requested_total
email_verification_sent_total

# Database Operations
mongodb_query_duration_seconds{operation="findUser"}
mongodb_connection_errors_total

# API Health
http_request_duration_seconds{method="POST",route="/api/v1/auth/login"}
http_requests_total{status="200|401|403|500"}
```

---

## âœ… SECURITY CHECKLIST

### **Pre-Production Deployment**

- [ ] Change all default passwords (especially MongoDB, Vault)
- [ ] Enable MongoDB authentication (currently NO AUTH!)
- [ ] Rotate all secrets (JWT, encryption, OAuth)
- [ ] Enable HSTS header (Strict-Transport-Security)
- [ ] Set up automated backups (MongoDB + secrets)
- [ ] Configure CloudFlare WAF (or similar)
- [ ] Enable Vault in production mode (not dev mode)
- [ ] Set up SSL certificate auto-renewal
- [ ] Configure log aggregation (ELK/Grafana Loki)
- [ ] Set up alerting rules (Alertmanager)
- [ ] Perform penetration testing
- [ ] Conduct security code review
- [ ] Set up incident response plan
- [ ] Configure DDoS protection
- [ ] Enable Docker security scanning (Snyk/Trivy)
- [ ] Run OWASP ZAP automated scan
- [ ] Test disaster recovery procedures
- [ ] Document all security controls
- [ ] Train team on security practices
- [ ] Set up security update monitoring

---

## ğŸ“ REFERENCES & COMPLIANCE

### **Standards Followed:**
- âœ… OWASP Top 10 (2021)
- âœ… NIST Cybersecurity Framework
- âœ… PCI DSS Level 1 (via Stripe SAQ-A)
- âš ï¸  GDPR (partial - needs user data deletion)
- âš ï¸  ISO 27001 (framework awareness)

### **Libraries & Frameworks:**
- bcrypt: Password hashing (NIST approved)
- jsonwebtoken: JWT RFC 7519 implementation
- helmet: Security headers (OWASP recommendations)
- express-rate-limit: DoS protection
- passport: OAuth 2.0 RFC 6749
- joi: Input validation
- crypto (Node.js): FIPS 140-2 compliant algorithms

---

**Generated:** November 12, 2025  
**Version:** 1.0  
**Project:** NT219 Secure E-Commerce Platform
